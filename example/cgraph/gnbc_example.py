import json
import fealpy.cgraph as cgraph
from fealpy.backend import backend_manager as bm
bm.set_backend("pytorch")
WORLD_GRAPH = cgraph.WORLD_GRAPH
pde = cgraph.create("CouetteFlow")
mesher = cgraph.create("Box2d")
phispace = cgraph.create("FunctionSpace")   
pspace = cgraph.create("P0FunctionSpace")
space = cgraph.create("FunctionSpace")
uspace = cgraph.create("TensorFunctionSpace")
simulation = cgraph.create("GNBCSimulation")
simulation2 = cgraph.create("GNBCSimulation")
simulation3 = cgraph.create("GNBCSimulation")
GNBC = cgraph.create("GNBC")
to_vtk = cgraph.create("TO_VTK")
to_vtk2 = cgraph.create("TO_VTK")
to_vtk3 = cgraph.create("TO_VTK")
pde(
    eps = 1e-10,
    T = 2,
    h = 1/256,
    theta = 77.6
)
mesher(
    domain = pde().domain,
    nx = pde().nx,
    ny = pde().ny
)
phispace(mesh = mesher(), p=1)
pspace(mesh = mesher(), ctype='D')
space(mesh = mesher(), p=2)
uspace(mesh = mesher(), p=2, gd = 2)
GNBC(Dirichlet = pde().is_uy_Dirichlet,
    space = space(),
    pspace = pspace(),
    uspace = uspace()
    )
simulation(
    dt = pde().dt,
    i = 0,
    param_list = pde().param_list,
    init_phi = pde().init_phi,
    is_wall_boundary = pde().is_wall_boundary,
    u_w = pde().u_w,
    phispace = phispace(),
    space = space(),
    pspace = pspace(),
    uspace = uspace(),
    NS_BC = GNBC().apply_bc, 
    q = 5)

to_vtk(mesh = mesher(),
        uh = (simulation().u1, simulation().p1, simulation().phi1, simulation().mu1),
        path = "/home/edwin/output",
        i = 0)

simulation2(
    dt = pde().dt,
    i = 1,
    param_list = pde().param_list,
    init_phi = pde().init_phi,
    is_wall_boundary = pde().is_wall_boundary,
    u_w = pde().u_w,
    phispace = phispace(),
    space = space(),
    pspace = pspace(),
    uspace = uspace(),
    NS_BC = GNBC().apply_bc,
    u0 = simulation().u0,
    u1 = simulation().u1,
    phi0 = simulation().phi0,
    phi1 = simulation().phi1, 
    q = 5)


to_vtk2(mesh = mesher(),
        uh = (simulation2().u1, simulation2().p1, simulation2().phi1, simulation2().mu1),
        path = "/home/edwin/output",
        i = 1)

simulation3(
    dt = pde().dt,
    i = 1,
    param_list = pde().param_list,
    init_phi = pde().init_phi,
    is_wall_boundary = pde().is_wall_boundary,
    u_w = pde().u_w,
    phispace = phispace(),
    space = space(),
    pspace = pspace(),
    uspace = uspace(),
    NS_BC = GNBC().apply_bc,
    u0 = simulation2().u0,
    u1 = simulation2().u1,
    phi0 = simulation2().phi0,
    phi1 = simulation2().phi1, 
    q = 5)


to_vtk3(mesh = mesher(),
        uh = (simulation3().u1, simulation3().p1, simulation3().phi1, simulation3().mu1),
        path = "/home/edwin/output",
        i = 2)

WORLD_GRAPH.output(path = to_vtk3().path)
                

# 最终连接到图输出节点上
WORLD_GRAPH.register_error_hook(print)
WORLD_GRAPH.execute()
print(WORLD_GRAPH.get())